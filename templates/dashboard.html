<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/jpg" href="../static/logo.jpg" />
    <title>TOX-3 Dashboard</title>

    <title>TOX-3 Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
        background: #0c121a;
      }
      /* Custom scrollbar hidden */
      ::-webkit-scrollbar {
        display: none;
      }
      /* Smooth chart line */
      .chart-line {
        stroke-linejoin: round;
        stroke-linecap: round;
      }
    </style>
  </head>
  <body class="min-h-screen flex items-center justify-center p-4 select-none">
    <div
      class="w-full max-w-6xl bg-gradient-to-tr from-[#111720] via-[#101519] to-[#0c121a] rounded-xl p-4 space-y-6 shadow-2xl border border-[#18202d80] md:p-8"
    >
      <!-- Header -->
      <header class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold text-cyan-400 tracking-wide md:text-3xl">
          Joseph
        </h1>
        <div class="flex items-center space-x-4">
          <a
            class="w-10 h-10 rounded-full bg-[#18202d] border border-[#2c344a] flex items-center justify-center text-gray-500"
            style="flex-direction: column; overflow: hidden"
            href="{{ url_for('logout') }}"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-4 h-4"
              fill="currentColor"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="1.5"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M5.121 17.804A9 9 0 1118.88 6.196a9 9 0 01-13.758 11.608z"
              />
            </svg>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-7 h-7"
              fill="currentColor"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="1.5"
              style="margin-bottom: -60%"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M5.121 17.804A9 9 0 1118.88 6.196a9 9 0 01-13.758 11.608z"
              />
            </svg>
          </a>
        </div>
      </header>

      <main class="grid grid-cols-12 gap-6">
        <!-- Left Graph Container -->
        <section
          class="col-span-12 md:col-span-7 bg-[#18202d] p-6 rounded-lg border border-[#2c344a]"
        >
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-gray-300 text-sm font-semibold md:text-xl">
              Past Performances
            </h2>
            <div
              class="flex items-center text-cyan-400 font-semibold text-lg space-x-1"
              id="text1"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-5 h-5 hidden"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="3"
                id="down-arrow"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M19 9l-7 7-7-7"
                />
              </svg>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-5 h-5 hidden"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="3"
                id="up-arrow"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M5 15l7-7 7 7"
                />
              </svg>
              <span id="close-prediction"></span>
            </div>
          </div>

          <!-- Chart -->
          <svg
            viewBox="0 0 400 180"
            xmlns="http://www.w3.org/2000/svg"
            aria-label="TSLA Prediction vs Real - 6 Days"
            role="img"
          >
            <!-- Y Axis -->
            <g
              stroke="#223344"
              stroke-width="1"
              font-size="10"
              fill="#5a697f"
              font-family="Inter, sans-serif"
            >
              <line x1="40" y1="30" x2="380" y2="30" />
              <text x="5" y="34">355</text>
              <line x1="40" y1="70" x2="380" y2="70" />
              <text x="5" y="74">340</text>
              <line x1="40" y1="110" x2="380" y2="110" />
              <text x="5" y="114">325</text>
              <line x1="40" y1="150" x2="380" y2="150" />
              <text x="5" y="154">310</text>
            </g>

            <!-- X Axis Labels -->
            <g
              fill="#5a697f"
              font-size="10"
              font-family="Inter, sans-serif"
              font-weight="600"
              text-anchor="middle"
            >
              <text x="60" y="165">20</text>
              <text x="60" y="177">Jun</text>
              <text x="104" y="165">23</text>
              <text x="104" y="177">Jun</text>
              <text x="148" y="165">24</text>
              <text x="148" y="177">Jun</text>
              <text x="192" y="165">25</text>
              <text x="192" y="177">Jun</text>
              <text x="236" y="165">26</text>
              <text x="236" y="177">Jun</text>
              <text x="280" y="165">27</text>
              <text x="280" y="177">Jun</text>
            </g>

            <!-- Real Data Dots -->
            <g fill="#22d3ee">
              <circle cx="60" cy="140" r="5" />
              <circle cx="104" cy="100" r="5" />
              <circle cx="148" cy="85" r="5" />
              <circle cx="192" cy="80" r="5" />
              <circle cx="236" cy="70" r="5" />
              <circle cx="280" cy="90" r="5" />
            </g>

            <!-- Predicted Data Dots -->
            <g fill="#a855f7">
              <circle cx="60" cy="138" r="5" />
              <circle cx="104" cy="102" r="5" />
              <circle cx="148" cy="88" r="5" />
              <circle cx="192" cy="82" r="5" />
              <circle cx="236" cy="72" r="5" />
              <circle cx="280" cy="92" r="5" />
            </g>

            <!-- Legend -->
            <g font-family="Inter, sans-serif" font-size="12" fill="#5a697f">
              <circle cx="320" cy="15" r="4" fill="#22d3ee" />
              <text x="330" y="19">Real</text>
              <circle cx="320" cy="35" r="4" fill="#a855f7" />
              <text x="330" y="39">Predict</text>
            </g>
          </svg>
        </section>

        <!-- Live Stocks values -->
        <!-- <section
          class="col-span-5 bg-[#18202d] p-6 rounded-lg border border-[#2c344a] space-y-4"
        ></section> -->

        <section
          class="col-span-12 md:col-span-5 bg-gradient-to-br from-[#1b2433] to-[#111827] p-5 rounded-lg border border-[#2a3347] shadow-[0_0_30px_#0f172a]"
        >
          <div class="header hidden flex justify-between" id="stock-header">
            <h2
              class="text-gray-300 text-xl font-semibold mb-6 tracking-wide flex items-center gap-2"
            >
              Stock Panel
            </h2>
            <div
              class="flex items-center gap-2 rounded-md bg-[#1f2a3c] border border-[#2a3347] shadow-[0_0_15px_#0f172a] justify-center"
              style="height: 30px; width: 70px"
            >
              <div
                class="w-2 h-2 bg-green-400 rounded-full animate-pulse"
              ></div>
              <span class="text-sm text-gray-300 font-medium tracking-wide"
                >Live</span
              >
            </div>
          </div>

          <div
            class="grid grid-cols-2 gap-y-9 gap-x-7 text-[15px] text-slate-300 font-medium lg:grid-cols-3 md:gap-y-12 hidden"
            id="stock-values"
          >
            <div class="justify-between items-center">
              <span style="font-size: small; margin-bottom: 20px"
                >Open Price</span
              ><br />
              <span class="text-blue-400 text-lg font-semibold" id="open-price"
                >$342.70</span
              >
            </div>
            <div class="justify-between items-center">
              <span style="font-size: small; margin-bottom: 20px"
                >High Price:</span
              ><br />
              <span class="text-green-400 text-lg font-semibold" id="high-price"
                >$343.00</span
              >
            </div>
            <div class="justify-between items-center">
              <span style="font-size: small; margin-bottom: 20px"
                >Low Price:</span
              ><br />
              <span class="text-red-400 text-lg font-semibold" id="low-price"
                >$320.40</span
              >
            </div>

            <div class="justify-between items-center">
              <span style="font-size: small; margin-bottom: 20px">Volume:</span
              ><br />
              <span class="text-gray-400 text-lg font-semibold" id="volume"
                >119,845,050</span
              >
            </div>
            <div class="justify-between items-center">
              <span style="font-size: small; margin-bottom: 20px"
                >Current Price:</span
              ><br />
              <span class="text-white text-lg font-semibold" id="current-price"
                >$327.55</span
              >
            </div>
            <div class="justify-between items-center">
              <span style="font-size: small; margin-bottom: 20px"
                >Past Close:</span
              ><br />
              <span
                class="text-slate-400 text-lg font-semibold"
                id="previous-close"
                >$340.47</span
              >
            </div>
          </div>
          <div
            class="w-full h-full flex flex-col items-center gap-3 justify-center bg-gradient-to-br from-[#1b2433] to-[#111827] text-white p-2"
            id="stock-panel"
            style="text-align: center"
          >
            <h2 class="text-2xl font-bold mb-2 text-gray-300">
              Market is NOT Open
            </h2>
            <p class="text-base text-gray-300 mb-4">Please try again later</p>
            <p class="text-sm text-gray-300">
              Time of Open: From
              <span class="font-semibold text-white">9:30 AM ET</span> to
              <span class="font-semibold text-white">4:00 PM ET</span>
            </p>
          </div>
        </section>

        <!-- Footer Stats -->
        <section class="col-span-12 grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
          <div
            class="bg-[#18202d] rounded-lg border border-[#2c344a] p-6 flex flex-col space-y-2"
            style="flex-wrap: wrap"
          >
            <p class="text-gray-300 text-sm md:text-lg">Direction Prediction</p>
            <div
              class="flex items-center space-x-2 font-semibold text-2xl"
              id="text"
            >
              <svg
                id="up-arrow1"
                xmlns="http://www.w3.org/2000/svg"
                class="w-8 h-8 hidden"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="3"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M5 15l7-7 7 7"
                />
              </svg>
              <svg
                id="down-arrow1"
                xmlns="http://www.w3.org/2000/svg"
                class="w-8 h-8 hidden"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="3"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M19 9l-7 7-7-7"
                />
              </svg>
              <span id="direction"></span>
              <span class="text-base font-normal ml-2" id="confidence"></span>
            </div>
          </div>

          <div
            class="bg-[#18202d] rounded-lg border border-[#2c344a] p-6 flex flex-col space-y-2 justify-center text-cyan-400"
          >
            <p class="text-gray-300 text-sm md:text-lg">Close Prediction</p>
            <span
              class="text-4xl font-mono font-semibold"
              id="close-prediction1"
            ></span>
          </div>

          <div
            class="bg-[#18202d] rounded-lg border border-[#2c344a] p-6 flex flex-col space-y-2 justify-center"
          >
            <p class="text-gray-400 text-sm md:text-lg">Accuracy</p>
            <p class="text-cyan-400 text-4xl font-mono font-bold">95.00%</p>
          </div>
        </section>
      </main>

      <!-- <div style="position: absolute">Joseph</div> -->
    </div>

    <script>
      const stockPanel = document.getElementById("stock-panel");
      const stockHeader = document.getElementById("stock-header");
      const stockValues = document.getElementById("stock-values");
      const openPrice = document.getElementById("open-price");
      const highPrice = document.getElementById("high-price");
      const lowPrice = document.getElementById("low-price");
      const currentPrice = document.getElementById("current-price");
      const volume = document.getElementById("volume");
      const previousClose = document.getElementById("previous-close");
      const closePrediction = document.getElementById("close-prediction");
      const direction = document.getElementById("direction");
      const confidence = document.getElementById("confidence");
      const text = document.getElementById("text");
      const upArrow = document.getElementById("up-arrow");
      const downArrow = document.getElementById("down-arrow");
      const closePrediction1 = document.getElementById("close-prediction1");
      const upArrow1 = document.getElementById("up-arrow1");
      const downArrow1 = document.getElementById("down-arrow1");
      const text1 = document.getElementById("text1");

      let closePredictionPrice;

      async function getSMA() {
        const apiKey = "58dc3e35f68445cc876321a5883d0ff6";
        const symbol = "TSLA";

        const sma5Url = `https://api.twelvedata.com/sma?symbol=${symbol}&interval=1day&time_period=5&apikey=${apiKey}`;
        const sma10Url = `https://api.twelvedata.com/sma?symbol=${symbol}&interval=1day&time_period=10&apikey=${apiKey}`;

        try {
          const [sma5Res, sma10Res] = await Promise.all([
            fetch(sma5Url),
            fetch(sma10Url),
          ]);

          const sma5Data = await sma5Res.json();
          const sma10Data = await sma10Res.json();

          if (sma5Data.status !== "ok" || sma10Data.status !== "ok") {
            throw new Error("Failed to fetch SMA data.");
          }

          const latestSMA5 = parseFloat(sma5Data.values[0].sma);
          const latestSMA10 = parseFloat(sma10Data.values[0].sma);

          console.log("âœ… SMA 5:", latestSMA5.toFixed(2));
          console.log("âœ… SMA 10:", latestSMA10.toFixed(2));

          return {
            latestSMA5,
            latestSMA10,
          };
        } catch (error) {
          console.error("âŒ Error fetching SMA data:", error.message);
        }
      }

      function getMarketStatusIST() {
        const now = new Date();

        // Convert to IST
        const istOffset = 5.5 * 60; // IST is UTC +5:30
        const utc = now.getTime() + now.getTimezoneOffset() * 60000;
        const ist = new Date(utc + istOffset * 60000);

        const hours = ist.getHours();
        const minutes = ist.getMinutes();

        // Convert current time to minutes since midnight
        const currentMinutes = hours * 60 + minutes;

        // Market hours in IST
        const marketOpen = 19 * 60; // 7:00 PM IST => 1140 minutes
        const marketClose = 1 * 60 + 30; // 1:30 AM IST => 90 minutes (next day)

        let marketStatus = "";

        // If currentMinutes is between 0:00 and 1:30 AM
        if (currentMinutes <= marketClose || currentMinutes >= marketOpen) {
          marketStatus = "Market Open";
          fetchStockData();
          setInterval(fetchStockData, 30000);
        } else {
          marketStatus = "Market Closed";
        }

        return {
          istTime: ist.toLocaleTimeString(),
          status: marketStatus,
        };
      }

      const fetchStockData = async () => {
        try {
          const response = await fetch(
            "https://api.twelvedata.com/quote?symbol=TSLA&apikey=a2cb5103faf94eceb233e0dc09f99f7b"
          );
          const data = await response.json();

          stockPanel.classList.add("hidden");
          stockHeader.classList.remove("hidden");
          stockValues.classList.remove("hidden");

          openPrice.textContent = `$${parseFloat(data.open).toFixed(2)}`;
          highPrice.textContent = `$${parseFloat(data.high).toFixed(2)}`;
          lowPrice.textContent = `$${parseFloat(data.low).toFixed(2)}`;
          volume.textContent = parseInt(data.volume).toLocaleString();
          previousClose.textContent = `$${parseFloat(
            data.previous_close
          ).toFixed(2)}`;
          currentPrice.textContent = `$${parseFloat(data.close).toFixed(2)}`;

          fetch("https://web-production-d4127.up.railway.app/predict", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              open: parseFloat(data.open),
              high: parseFloat(data.high),
              low: parseFloat(data.low),
              volume: parseInt(data.volume),
            }),
          })
            .then((res) => res.json())
            .then((result) => {
              closePredictionPrice = result.predicted;
              closePrediction.textContent = `$${result.predicted}`;
              closePrediction1.textContent = `$${result.predicted}`;
            });

          const open = parseFloat(data.open);
          const high = parseFloat(data.high);
          const low = parseFloat(data.low);
          const close = parseFloat(closePredictionPrice);
          const volume1 = parseInt(data.volume);
          const prevClose = parseFloat(data.previous_close);

          // === Compute extra features ===
          const returnPercent = ((close - prevClose) / prevClose) * 100;
          const hlRangePercent = ((high - low) / open) * 100;
          const coDiff = close - open;

          // === SMA 5 & SMA 10 ===
          const smaData = await getSMA();

          console.log("SMA 5:", smaData.latestSMA5);
          const features = [
            open,
            high,
            low,
            close,
            volume1,
            parseFloat(returnPercent.toFixed(2)),
            parseFloat(hlRangePercent.toFixed(2)),
            parseFloat(coDiff.toFixed(2)),
            smaData.latestSMA5,
            smaData.latestSMA10,
          ];

          console.log("ðŸ“¦ Features â†’", features);

          fetch("https://tire3-backend.onrender.com/predict", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ features: [features] }), // nested in another array because model expects 2D input
          })
            .then((res) => res.json())
            .then((result) => {
              console.log(result);
              const prediction = result.results[0];
              console.log("Prediction:", prediction);
              confidence.textContent = `${prediction.confidence.toFixed(1)}%`;
              prediction.predicted === 0
                ? (direction.textContent = "Down")
                : (direction.textContent = "Up");
              prediction.predicted === 0
                ? text.classList.add("text-red-500")
                : text.classList.add("text-green-500");
              prediction.predicted === 0
                ? text1.classList.add("text-red-500")
                : text1.classList.add("text-green-500");
              prediction.predicted === 0
                ? downArrow.classList.remove("hidden")
                : upArrow.classList.remove("hidden");
              prediction.predicted === 0
                ? downArrow1.classList.remove("hidden")
                : upArrow1.classList.remove("hidden");
            })
            .catch((err) => {
              console.error("Prediction error:", err);
            });

          console.log(data);
        } catch (error) {
          console.error("Error fetching stock data:", error);
        }
      };

      // fetchStockData();

      getMarketStatusIST();
    </script>
  </body>
</html>
